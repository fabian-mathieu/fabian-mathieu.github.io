<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Dataviz - Mobilités durables">
  <meta name="author" content="Fabian MATHIEU">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="Cache-Control" content="max-age=31536000, must-revalidate">
  <title>Tableau de bord - Indicateurs de mobilité</title>
  <link rel="icon" type="image/x-icon" href="img/icon.png">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
  <header>
    <div class="pnr">
      <a href="index.html"><img class="logo" src="img/clipboard-data_blue.svg" width="64" height="105"></a>
      <h1><a href="index.html">Tableau de bord - Mobilités durables dans l'EMS</a></h1>
    </div>
    <nav class="nav">
      <ul class="ul">
        <li class="active"><a href="index.html"><img src="img/house_white.svg" width="16" height="16">Accueil</a></li>
        <li><a href="marche.html"><img src="img/person_walking_blue.svg" width="16" height="16">Marche</a></li>
        <li><a href="velos.html"><img src="img/bicycle_blue.svg" width="16" height="16">Vélos</a></li>
        <li><a href="vehicules_legers.html"><img src="img/car-front-fill_blue.svg" width="16" height="16">Véhicules légers</a></li>
        <li><a href="bus.html"><img src="img/bus-front_blue.svg" width="16" height="16">Bus</a></li>
        <li><a href="tram.html"><img src="img/lightrail_blue.svg" width="16" height="16">Tram</a></li>
        <li><a href="autopartage.html"><img src="img/car-sharing_blue.svg" width="16" height="16">Autopartage</a></li>
        <li><a href="a_propos.html"><img src="img/info_blue.svg" width="16" height="16">À propos</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <h1>Visualisation des indicateurs de mobilité</h1>

    <label for="indicateur-filter" style="margin-left:2%;">Choisir un indicateur :</label>
    <select id="indicateur-filter">
      <option value="part_surface_pietonne">Part surface piétonne</option>
      <option value="pourcentage_vegetation">Pourcentage végétation</option>
      <option value="part_surface_cyclable">Part surface cyclable</option>
      <option value="nb_stations_velhop">Stations Vélhop</option>
      <option value="nb_accidents_velo">Accidents vélo</option>
      <option value="nb_bornes_ve">Bornes VE</option>
      <option value="population_estimee">Population estimée</option>
      <option value="bruit_moy_route_db">Bruit moyen (dB)</option>
    </select>

    <div id="mymap" style="height: 600px;"></div>

    <script>
      var mymap = L.map('mymap', { center: [47.1359, 2.12495], zoom: 6 });

      var baselayers = {
        fond_osm: L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }),
        fond_carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
          attribution: '<a href="https://carto.com/basemaps">cartocdn</a>'
        })
      };
      baselayers.fond_carto.addTo(mymap);

      L.control.scale().addTo(mymap);
      L.control.layers(baselayers, null, { position: 'topright' }).addTo(mymap);

      let indicateurActif = "part_surface_pietonne";
      let geojson;

      document.getElementById('indicateur-filter').addEventListener('change', function () {
        indicateurActif = this.value;
        if (geojson) {
          geojson.setStyle(style);
        }
      });

      // Fonction pour déterminer la couleur en fonction de la valeur de l'indicateur
      function getColor(value, indicateur) {
        if (value === null || value === undefined || value < 0) return '#CCCCCC'; // Gris pour valeurs manquantes
        
        switch(indicateur) {
          case 'part_surface_pietonne':
          case 'part_surface_cyclable':
          case 'pourcentage_vegetation':
            // Du vert clair au vert foncé pour les indicateurs de part
            return value > 75 ? '#005a32' :
                   value > 50 ? '#238b45' :
                   value > 25 ? '#41ab5d' :
                   value > 0 ? '#74c476' :
                   '#f7fcf5';
          case 'nb_stations_velhop':
          case 'nb_bornes_ve':
            // Du bleu clair au bleu foncé pour les infrastructures
            return value > 5 ? '#084594' :
                   value > 3 ? '#2171b5' :
                   value > 1 ? '#4292c6' :
                   value > 0 ? '#6baed6' :
                   '#f7fbff';
          case 'nb_accidents_velo':
            // Du rouge clair au rouge foncé pour les accidents
            return value > 5 ? '#99000d' :
                   value > 3 ? '#cb181d' :
                   value > 1 ? '#ef3b2c' :
                   value > 0 ? '#fb6a4a' :
                   '#fff5f0';
          case 'population_estimee':
            // Du orange clair au orange foncé pour la population
            return value > 500 ? '#8c2d04' :
                   value > 200 ? '#cc4c02' :
                   value > 100 ? '#ec7014' :
                   value > 0 ? '#fe9929' :
                   '#fff5eb';
          case 'bruit_moy_route_db':
            // Du jaune au rouge pour le bruit
            return value > 70 ? '#bd0026' :
                   value > 60 ? '#f03b20' :
                   value > 50 ? '#fd8d3c' :
                   value > 40 ? '#feb24c' :
                   value > 30 ? '#fed976' :
                   '#ffffb2';
          default:
            return '#3388ff';
        }
      }

      function style(feature) {
        const valeur = feature.properties[indicateurActif];
        return {
          weight: 0.5,
          opacity: 1,
          color: 'white',
          dashArray: '3',
          fillOpacity: 0.7,
          fillColor: getColor(valeur, indicateurActif)
        };
      }

      var info = L.control();
      info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info');
        this.update();
        return this._div;
      };

      info.update = function (props) {
        if (!props) {
          this._div.innerHTML = '<h4>Indicateurs de mobilité</h4>Survolez un carreau';
          return;
        }

        const indicateurLabel = document.getElementById('indicateur-filter').options[document.getElementById('indicateur-filter').selectedIndex].text;
        const valeur = props[indicateurActif] !== null && props[indicateurActif] !== undefined ? props[indicateurActif] : 'Donnée non disponible';

        this._div.innerHTML = `
          <h4>Indicateurs de mobilité</h4>
          <b>ID carreau :</b> ${props.idINSPIRE}<br>
          <b>${indicateurLabel} :</b> ${valeur}<br><br>
          <b>Autres indicateurs :</b><br>
          • Population estimée : ${props.population_estimee || 0}<br>
          • Stations Vélhop : ${props.nb_stations_velhop || 0}<br>
          • Bornes VE : ${props.nb_bornes_ve || 0}<br>
          • Accidents vélo : ${props.nb_accidents_velo || 0}
        `;
      };
      info.addTo(mymap);

      function highlightFeature(e) {
        var layer = e.target;
        layer.setStyle({
          weight: 3,
          color: '#FFFFFF',
          dashArray: '',
          fillOpacity: 0.9
        });
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
          layer.bringToFront();
        }
        info.update(layer.feature.properties);
      }

      function resetHighlight(e) {
        geojson.resetStyle(e.target);
        info.update();
      }

      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          mouseout: resetHighlight,
          click: function (e) {
            layer.bindPopup(getPopupContent(feature.properties)).openPopup();
          }
        });
      }
      
      function getPopupContent(props) {
        if (!props) return '';
        
        const indicateurLabel = document.getElementById('indicateur-filter').options[document.getElementById('indicateur-filter').selectedIndex].text;
        const valeur = props[indicateurActif] !== null && props[indicateurActif] !== undefined ? props[indicateurActif] : 'Donnée non disponible';
        
        let content = `
          <div style="max-width: 300px;">
            <h4>Détails du carreau</h4>
            <b>ID :</b> ${props.idINSPIRE}<br>
            <b>Indicateur actuel (${indicateurLabel}) :</b> ${valeur}<br><br>
            
            <b>Indicateurs piétons :</b><br>
            • Part surface piétonne : ${props.part_surface_pietonne || 0}%<br>
            • Longueur voies lentes : ${props.longueur_lente ? props.longueur_lente.toFixed(1) : 0}m<br><br>
            
            <b>Indicateurs vélo :</b><br>
            • Part surface cyclable : ${props.part_surface_cyclable || 0}%<br>
            • Stations Vélhop : ${props.nb_stations_velhop || 0}<br>
            • Accidents vélo : ${props.nb_accidents_velo || 0}<br><br>
            
            <b>Indicateurs véhicules :</b><br>
            • Bornes VE : ${props.nb_bornes_ve || 0}<br>
            • Bruit moyen : ${props.bruit_moy_route_db || '?'} dB<br>
            • Pente moyenne : ${props.pente_moyenne ? props.pente_moyenne.toFixed(1) : '?'}%
          </div>
        `;
        
        return content;
      }

      // Chargement du GeoJSON
      fetch('data_leaflet/carreaux_200m_avec_donnees.geojson')
        .then(response => response.json())
        .then(data => {
          // Conversion des coordonnées EPSG:3857 en WGS84 si nécessaire
          geojson = L.geoJson(data, {
            style: style,
            onEachFeature: onEachFeature
          }).addTo(mymap);
          
          // Ajuster la vue pour afficher toutes les données
          mymap.fitBounds(geojson.getBounds());
        })
        .catch(error => {
          console.error('Erreur lors du chargement des données:', error);
        });
    </script>
  </main>
</body>
</html>